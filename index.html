<meta charset="utf-8"/>
<html>
    <head>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/d3-simple-slider"></script>
        <script src="expect.js/index.js"></script>
        <script src="d3tip.js"></script>
        <script src="posit.js"></script>
        <script src="viz.js"></script>
        <title>CSE512 | A3 Posit Bisection</title>
        <!-- Stylesheet from CSE512 faculty -->
        <style media="all">
         * { padding: 0; margin: 0; }
         body {
             margin: 0 auto 0 auto;
             padding: 0;
             max-width: 1200px;
             font-family: "Avenir", "Avenir Next", Helvetica Neue, Arial;
             font-size: 0.95em;
         }
         a, a:visited { text-decoration: none; color: #7533f4; }
         a:hover { text-decoration: underline; color: #f4b014; }
         h1, h2, h3, h4, h5 {
             color: #492a7c;
             background-color: inherit;
             font-weight: normal;
             padding: 0 0 5px 0;
             margin: 15px 0 0 0;
             border: none;
             clear: right;
         }
         h1 { font-size: 24pt; margin:  5px 0 10px 0; line-height: 28px; }
         h2 { font-size: 14pt; margin: 30px 0 15px 0; letter-spacing: 0.01em; border-bottom: 1px solid #ccc;  line-height: 20px;}
         h3 { font-size: 13pt; }
         h4 { font-size: 12pt; }
         h5 { font-size: 11pt; }
         p { margin: 0 0 10px 0; }
         .content {
             margin: 0;
             padding: 15px 20px;
             background-color: #ffffff;
         }
         .title, .title h1, .title a {
             color: #492a7c;
             font-size: 24pt;
             margin-bottom: 20px;
             margin-top: 5px;
         }
         .footer {
             border-top: 1px solid #ccc;
             margin-top: 30px;
             padding-top: 4px;
             text-align: right;
             font-size: 12px;
         }
         .footer a {
             color: #21346B;
         }
         .footer a:hover {
             color: #ce3333;
         }
        </style>
    </head>
    <body>
        <div class="content">
            <section class="title">
                <a href="/">Posit Bisection</a>
            </section>

            <section>
                <p>
                    <strong>Team Members</strong>: Neil Ryan, Katie Lim, Gus Smith, Dan Petrisko
                </p>
            </section>

            <section>
                <p>
                    <a href="http://www.johngustafson.net/pdfs/BeatingFloatingPoint.pdf"><i>Posits</i></a> are a new numerical datatype developed to compete with the standard IEEE 754 format. Posits add a number of very interesting features over IEEE floating point, but the most interesting at a high level are (1) the addition of the <tt>es</tt> parameter, and (2) the addition of the <i>regime</i> bitfield.
                </p>

                <p>
                    IEEE floating point numbers have only one parameter, <tt>n</tt>, which describes their length (generally 32 or 64). In addition to <tt>n</tt>, posits have another parameter <tt>es</tt>. <tt>es</tt> determines two things:
                    <ul>
                        <li>The maximum length of the exponent field, and</li>
                        <li>The value of a constant <tt>useed</tt> that is used in calculating the value of the posit, where <tt>useed</tt> is <tt>2^2^es</tt>.</li>
                    </ul>
                </p>

                <p>
                    The <i>regime</i> bitfield is a varying-length, unary-encoded field which comes just after the posit's sign field. The field is encoded as a number of 0s ending with a 1, or a number of 1s ending with a 0: <tt>001</tt> or <tt>1110</tt>, for example. The number of 1s or 0s translates to the sign and value of <tt>k</tt>, a number used to calculate the value of the posit.
                </p>

                <p>
                    The final posit is calculated as <tt>sign * useed^k * 2^exponent * 1.fraction</tt>.
                </p>

                <p>
                    In this project, we present an interactive version of the visualization shown on page 2 of <a href="http://www.johngustafson.net/pdfs/BeatingFloatingPoint.pdf">John Gustafson's original posit paper</a> and page 16 of <a href="https://posithub.org/conga/2019/docs/13/1000-PeterLindstrom.pdf">Peter Lindstrom's CoNGA 2019 slides</a>. This visualization shows the posits laid out on the <i>projectively-extended real number line</i>, which is the real number line we are used to, but with both infinities being represented by the same point. This makes sense for posits, as posits only have one representation for infinity. The process of filling out the values on this circle is often called <i>posit bisection</i>, hence the title of this visualization.
                </p>
            </section>

            <table style="margin-left:auto; margin-right:auto">
                <tr>
                    <td><div id=n-text></div></td>
                    <td> <div style="text-align:center;" id="slider-n"></div> </td>
                    <td><div id=bitstring-fraction-button></div></td>
                </tr>
                <tr>
                    <td><div id=es-text></div></td>
                    <td><div style="text-align:center;" id="slider-es"></div> </td>
                </tr>
            </table>
            <div id="circle-viz" style="text-align:center;"></div>
            <div class="footer">
                <a href="https://courses.cs.washington.edu/courses/cse512/19sp/">CSE 512 Data Visualization</a>
                <a href="http://www.washington.edu">University of Washington</a>
            </div>
        </div>
    </body>
    <script type="text/javascript">

    const label_format = {
        FRACTION: 'fraction',
        BITSTRING: 'bitstring'
    };

    const dot_opacity = {
        FOCUSED: 1.0,
        UNFOCUSED: 0.6
    }

    const dot_radius = {
        FOCUSED: 7,
        UNFOCUSED: 5
    }

     // Posit parameters
     var n = 4; var es = 1;
     var displayFormat = label_format.BITSTRING;
     const nLowerBound = 2; const nUpperBound = 8;
     const esLowerBound = 0;
     const sliderLowerBound = esLowerBound;
     const sliderUpperBound = nUpperBound;

     var width = 1000; var height = 1000;
     // An assumption I'm making.
     console.assert(width === height);

     var margin = {left : 50, top : 50, right : 50, bottom : 50};

     var svg_viz_container = d3.select("#circle-viz").append('svg')
                       .attr('width', margin.left + width + margin.right)
                       .attr('height', margin.top + height + margin.bottom)
     // A trick to make a margin without needing the drawing logic to reason about it.
     // See https://bl.ocks.org/mbostock/3019563.
                       .append('g')
                       .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');


    update(width, height, n, es, displayFormat)

    var selectFractionButton = d3.select("#bitstring-fraction-button")
                               .append('button')
                               .text('See Fraction Values')
                               .on('click', function (d) {
                                   if (d3.select(this).text() == 'See Fraction Values') {
                                     d3.select(this).text('See Bitstring Values');
                                     displayFormat = label_format.FRACTION;
                                   } else { 
                                     d3.select(this).text('See Fraction Values');
                                     displayFormat = label_format.BITSTRING;
                                   }

                                    update(width, height, n, es, displayFormat)
                                });

    // https://bl.ocks.org/johnwalley/e1d256b81e51da68f7feb632a53c3518
    var sliderES = d3
        .sliderBottom()
        .domain([sliderLowerBound, sliderUpperBound])
        .step(1)
        .ticks(sliderUpperBound - sliderLowerBound)
        .width(300)
        .default(es)
        .displayFormat(d3.format('d'))
        .tickFormat(d3.format('d'))
        .on('onchange', val => {
            es = val;
            update(width, height, n, es, displayFormat);
        });

    var sliderN = d3
        .sliderBottom()
        .domain([nLowerBound, sliderUpperBound])
        .step(1)
        .ticks(sliderUpperBound - nLowerBound)
        .width(300)
        .default(n)
        .displayFormat(d3.format('d'))
        .tickFormat(d3.format('d'))
        .on('onchange', val => {
            if (val < nLowerBound) {
                sliderN.silentValue(Math.max(nLowerBound, es+1));
            } else {
                n = val;
            }
            update(width, height, n, es, displayFormat);
        });

    d3.select('#slider-n')
        .append('svg')
        .attr('width', 400)
        .attr('height', 100)
        .append('g')
        .attr('transform', 'translate(50,50)')
        .call(sliderN);

    d3.select('#slider-es')
        .append('svg')
        .attr('width', 400)
        .attr('height', 100)
        .attr('align', 'center')
        .append('g')
        .attr('transform', 'translate(50,50)')
        .attr('id', 'es-group')
        .call(sliderES);


     d3.select("#n-text").append('text')
                .attr("transform", `translate(${(width)/2},-20)`)
                .style('text-anchor', 'middle')
                .style('font-weight', 700)
                .text("N:");
     
     d3.select("#es-text").append('text')
                .attr("transform", `translate(${(width)/2},-20)`)
                .style('text-anchor', 'middle')
                .style('font-weight', 700)
                .text("ES:");
    </script>
</html>
